@{
    Layout = "~/Views/Shared/_FinaLayout.cshtml";
    ViewBag.Title = "Seguridad - GC Conautopcion";
}

<div class="row">
    <div class="col-md-12">
        <h2>
            <i class="fa fa-lock text-primary"></i>
            Configuraci&oacute;n de Seguridad - Portal GC Conautopcion
        </h2>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card fina-card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fa fa-key"></i>
                    Cambiar Contrase&ntilde;a
                </h5>
            </div>
            <div class="card-body">
                <form id="finaPasswordForm">
                    <div class="form-group">
                        <label for="currentPassword">Contrase&ntilde;a Actual:</label>
                        <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">Nueva Contrase&ntilde;a:</label>
                        <input type="password" class="form-control" id="newPassword" name="newPassword" required>
                        <small class="form-text text-muted">
                            La contrase&ntilde;a debe tener al menos 8 caracteres, incluir may&uacute;sculas, min&uacute;sculas y n&uacute;meros.
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirmar Nueva Contrase&ntilde;a:</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                    </div>
                    <button type="submit" class="btn fina-btn text-white">
                        <i class="fa fa-save"></i>
                        Cambiar Contrase&ntilde;a
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card fina-card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fa fa-shield"></i>
                    Seguridad del Portal GC Conautopcion
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fa fa-check-circle text-success"></i>
                        <small>Conexi&oacute;n segura SSL</small>
                    </li>
                    <li class="mb-2">
                        <i class="fa fa-check-circle text-success"></i>
                        <small>Cifrado de datos espec&iacute;fico para GC Conautopcion</small>
                    </li>
                    <li class="mb-2">
                        <i class="fa fa-check-circle text-success"></i>
                        <small>Autenticaci&oacute;n robusta</small>
                    </li>
                    <li class="mb-2">
                        <i class="fa fa-check-circle text-success"></i>
                        <small>Monitoreo de accesos GC Conautopcion</small>
                    </li>
                </ul>
            </div>
        </div>

        <div class="card fina-card mt-3">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fa fa-exclamation-triangle"></i>
                    Recomendaciones
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fa fa-arrow-right text-primary"></i>
                        <small>Cambie su contrase&ntilde;a regularmente</small>
                    </li>
                    <li class="mb-2">
                        <i class="fa fa-arrow-right text-primary"></i>
                        <small>No comparta sus credenciales</small>
                    </li>
                    <li class="mb-2">
                        <i class="fa fa-arrow-right text-primary"></i>
                        <small>Cierre sesi&oacute;n al terminar</small>
                    </li>
                    <li class="mb-2">
                        <i class="fa fa-arrow-right text-primary"></i>
                        <small>Use una red segura</small>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card fina-card">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">
                    <i class="fa fa-history"></i>
                    Historial de Accesos Recientes
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>IP</th>
                                <th>Navegador</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="accessHistoryTable">
                            <tr>
                                <td>@DateTime.Now.ToString("dd/MM/yyyy")</td>
                                <td>@DateTime.Now.ToString("HH:mm:ss")</td>
                                <td>192.168.1.100</td>
                                <td>Chrome</td>
                                <td><span class="badge badge-success">Exitoso</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#finaPasswordForm').on('submit', function (e) {
                e.preventDefault();
                changeFinaPassword();
            });
        });

        function changeFinaPassword() {
            var currentPassword = $('#currentPassword').val();
            var newPassword = $('#newPassword').val();
            var confirmPassword = $('#confirmPassword').val();

            // Validaciones básicas
            if (!currentPassword || !newPassword || !confirmPassword) {
                showMessage('Por favor complete todos los campos', 'warning');
                return;
            }

            if (newPassword !== confirmPassword) {
                showMessage('Las contraseñas no coinciden', 'danger');
                return;
            }

            if (newPassword.length < 8) {
                showMessage('La contraseña debe tener al menos 8 caracteres', 'warning');
                return;
            }

            // Aquí iría la llamada AJAX para cambiar la contraseña específicamente para usuarios de GC Conautopcion
            $.ajax({
                url: '@Url.Action("updUsuario", "Security")', // Reutilizamos el endpoint existente
                type: 'POST',
                data: {
                    email: getCookie('Nombre'),
                    password: currentPassword,
                    NewPassword: newPassword
                },
                success: function (response) {
                    if (response === "Password actualizado") {
                        showMessage('Contraseña actualizada exitosamente en el portal GC Conautopcion', 'success');
                        $('#finaPasswordForm')[0].reset();
                    } else {
                        showMessage('Error al actualizar contraseña: ' + response, 'danger');
                    }
                },
                error: function () {
                    showMessage('Error en el servidor al cambiar la contraseña', 'danger');
                }
            });
        }

        function getCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function showMessage(message, type) {
            var alertClass = 'alert-' + type;
            var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                '<i class="fa fa-info-circle"></i> ' + message +
                '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                '<span aria-hidden="true">&times;</span>' +
                '</button>' +
                '</div>';

            // Remover alertas anteriores
            $('.alert').remove();
            // Agregar nueva alerta al principio del contenido
            $(alertHtml).prependTo('.container');
        }
    </script>
}